# أداة توقيتات الفيديو لملفات MDX

سكريبت Node.js يقوم تلقائياً بإضافة توقيتات الفيديو إلى محتوى MDX عن طريق مطابقته مع ملفات الترجمة SRT. السكريبت مُحسّن خصيصاً للمحتوى العربي ويستخدم خوارزميات ذكية لمطابقة النصوص مع توقيتات الفيديو.


## الفكرة الأساسية

يحل السكريبت مشكلة شائعة في إدارة محتوى الفيديو: مطابقة النص المحرر والمنسق مع توقيتات الفيديو الأصلية. يعمل من خلال:

1. **تنميط النص**: تحويل كل من محتوى MDX و SRT إلى صيغة قابلة للمقارنة عن طريق:
   - إزالة التشكيل وعلامات الترقيم
   - توحيد أشكال الحروف العربية
   - توحيد المسافات والتنسيق

2. **المطابقة الذكية**: استخدام تقنية النافذة المنزلقة لـ:
   - مطابقة الفقرات مع مقاطع الترجمة المقابلة
   - اكتشاف أوقات بداية أفضل للفقرات بالنظر إلى انتقالات المقاطع
   - دمج مقاطع ترجمة متعددة للفقرات الطويلة

3. **إضافة التوقيتات**: إضافة مكونات `VideoTimeAt` حول المحتوى المطابق مع الحفاظ على تنسيق Markdown.

## الإعدادات

السكريبت قابل للتخصيص بشكل كبير من خلال كائن الإعدادات المركزي:

```javascript
const CONFIG = {
    // إعدادات المطابقة
    MAX_SEGMENTS_TO_COMBINE: 5,      // الحد الأقصى لمقاطع SRT المراد دمجها
    SIMILARITY_THRESHOLD: 0.4,        // الحد الأدنى للتطابق الرئيسي
    START_SIMILARITY_THRESHOLD: 0.5,  // حد اكتشاف وقت البداية
    WINDOW_SIZE: 10,                 // عدد الكلمات للتحقق من البداية/النهاية

    // تنسيق المخرجات
    ADD_BLANK_LINES: true,           // إضافة أسطر فارغة حول المكونات
    INDENT_SPACES: 2,                // عدد المسافات للمسافة البادئة

    // إعدادات التصحيح
    VERBOSE: false,                  // إظهار معلومات المطابقة المفصلة
    LOG_PROGRESS: true,              // إظهار تقدم المعالجة
    
    // معالجة النص
    MIN_PARAGRAPH_LENGTH: 10,        // الحد الأدنى لطول الفقرة للمعالجة
    MAX_LOOK_BACK_SEGMENTS: 2        // عدد المقاطع للتحقق من أوقات البداية
};
```

## الاستخدام

### الاستخدام الأساسي

```bash
node syncWithVideo.js <mdx-file> <srt-file> <output-file>
```

مثال:
```bash
node syncWithVideo.js transcript.mdx subtitles.srt output.mdx
```

مثال آخر: **انظر الى "./examples/syncWithVideo/case 1"**

## تفاصيل حل المشكلة

### تنميط النص (خاص باللغة العربية)

```javascript
function normalizeArabicText(text) {
    return text
        .replace(/[^\u0600-\u06FF\s]/g, '')  // الاحتفاظ بالحروف العربية والمسافات
        .replace(/\s+/g, ' ')                // توحيد المسافات
        .replace(/[،.؟!:]/g, '')             // إزالة علامات الترقيم
        .replace(/آ/g, 'ا')                  // توحيد الألف
        .replace(/[ًٌٍَُِّْ]/g, '')            // إزالة التشكيل
        .replace(/ة/g, 'ه')                 // توحيد التاء المربوطة
        .replace(/إ|أ/g, 'ا')               // توحيد الهمزة
        .replace(/[ىي]/g, 'ي')              // توحيد الياء
        .trim();
}
```

### خوارزمية المطابقة الذكية

تعمل عملية المطابقة على ثلاث مراحل:

1. **المطابقة الأولية**: 
   - تجد أفضل تسلسل مطابق من مقاطع SRT لكل فقرة
   - تستخدم درجة تشابه تعتمد على الكلمات المشتركة

2. **تحسين وقت البداية**:
   - تنظر في المقاطع السابقة لإيجاد نقاط بداية أفضل للفقرات
   - مفيد عندما تبدأ الفقرات في منتصف المقطع

3. **ضبط التوقيت**:
   - تحسب أوقات البداية/النهاية المناسبة
   - تتعامل مع انتقالات المقاطع

مثال على حساب التشابه:
```javascript
function calculateSimilarity(text1, text2) {
    const words1 = text1.split(' ');
    const words2 = text2.split(' ');
    const commonWords = words1.filter(word => words2.includes(word)).length;
    return (2.0 * commonWords) / (words1.length + words2.length);
}
```

### أمثلة المدخلات والمخرجات

#### مدخلات MDX
```markdown
# العنوان

هذا النص سيتم ربطه مع توقيت الفيديو المناسب.
```

#### مدخلات SRT
```
1
00:00:01,600 --> 00:00:15,750
هذا النص سيتم ربطه

2
00:00:16,000 --> 00:00:31,850
مع توقيت الفيديو المناسب
```

#### مخرجات MDX
```markdown
# العنوان

<VideoTimeAt startTime={1} endTime={31}>
هذا النص سيتم ربطه مع توقيت الفيديو المناسب.
</VideoTimeAt>
```

## التصحيح والتحسين

يتضمن السكريبت عدة ميزات للتصحيح:

1. **سجل التقدم**:
   - يظهر عدد المقاطع المعالجة
   - يعرض درجات المطابقة
   - يشير إلى مراحل المعالجة

2. **الوضع المفصل**:
   - يمكّن معلومات المطابقة المفصلة
   - يظهر درجات التشابه
   - يعرض تعديلات التوقيت

## السيناريوهات الشائعة

### 1. الفقرات عبر المقاطع
عندما تمتد الفقرة عبر مقاطع SRT متعددة، يقوم السكريبت بـ:
- دمج المقاطع حتى MAX_SEGMENTS_TO_COMBINE
- الحفاظ على استمرارية التوقيت
- ضمان اختيار مناسب لوقت البداية/النهاية
- 
### 3. الحفاظ على التنسيق
يحافظ السكريبت بعناية على:
- تنسيق Markdown
- العناوين والهيكل
- تباعد النص الأصلي
- سلامة الحروف العربية

## استكشاف الأخطاء وإصلاحها

### المشاكل الشائعة

1. **ضعف المطابقة**
   - اضبط SIMILARITY_THRESHOLD
   - تحقق من تنميط النص
   - تأكد من ترميز الملف

2. **توقيتات غير صحيحة**
   - عدّل START_SIMILARITY_THRESHOLD
   - اضبط MAX_LOOK_BACK_SEGMENTS
   - تحقق من إعدادات دمج المقاطع

3. **معالجة الاخطاء**
   - تحقق من مسارات الملفات
   - تأكد من ترميز الملفات (استخدم UTF-8)
   - تأكد من صحة نهايات الأسطر
